parameters:
  - name: serviceConnection
    type: string

steps:
- task: AzureCLI@2
  displayName: "Azure OIDC Authentication"
  inputs:
    azureSubscription: ${{ parameters.serviceConnection }}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      echo "üîê Authenticated with Azure using OIDC"
      echo "üìù Subscription: $(az account show --query name -o tsv)"
      echo "Setting ARM environment variables for Terraform..."
      echo "##vso[task.setvariable variable=ARM_CLIENT_ID]$servicePrincipalId"
      echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID]$(az account show --query id -o tsv)"
      echo "##vso[task.setvariable variable=ARM_TENANT_ID]$tenantId"
      echo "##vso[task.setvariable variable=ARM_USE_OIDC]true"
      echo "##vso[task.setvariable variable=ARM_OIDC_TOKEN]$idToken"
    addSpnToEnvironment: true
    useGlobalConfig: true
