parameters:
  - name: environment
    type: string
  - name: basePath
    type: string
  - name: displayName
    type: string
    default: ''

steps:
  - task: Bash@3
    displayName: ${{ coalesce(parameters.displayName, format('Terragrunt Validate - {0}', parameters.environment)) }}
    inputs:
      targetType: inline
      script: |
        set -euo pipefail
        dir="${{ parameters.basePath }}/${{ parameters.environment }}"
        echo "ðŸ”„ Validating Terragrunt in $dir..."

        # Set environment variable for terragrunt
        export ENVIRONMENT="${{ parameters.environment }}"

        pushd $dir
        # Validate all Terragrunt configurations
        terragrunt validate-all
        popd

        echo "âœ… Terragrunt validation valid for ${{ parameters.environment }}"
    env:
      TF_VAR_pat_value: $(azure-devops-pat-${{ parameters.environment }})
      TF_VAR_client_secret_vmss: $(vmss-agent-pool-sp-secret-${{ parameters.environment }})
      TF_VAR_admin_ssh_public_key: $(admin-ssh-public-key-${{ parameters.environment }})
      TF_INPUT: "0"
      TERRAGRUNT_NON_INTERACTIVE: "true"
